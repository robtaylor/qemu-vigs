EMUL_DIR=../Emulator

ifneq ($(wildcard ../../config-host.mak),)
include ../../config-host.mak
else
config-host.mak:
	@echo "Please call configure before running make!"
	@exit 1
endif

export CONFIG_OPENGLES

ifdef CONFIG_OPENGLES
ifdef CONFIG_WIN32
GLESLIBS_LIST:=$(wildcard ../../arm-softmmu/*.dll)
else
GLESLIBS_LIST:=$(wildcard ../../arm-softmmu/lib*)
endif
endif

all: build_info qemu skin_client check_hax
qemu:
	cd ../../ && $(MAKE)
check_hax:
ifdef CONFIG_WIN32
	$(CC) -o check-hax.exe check_hax.c
else
	
endif
skin_client:
ifdef CONFIG_WIN32
	ant -buildfile skin/client/build.xml windows-jar
else
ifdef CONFIG_LINUX
	ant -buildfile skin/client/build.xml linux-jar
else
ifdef CONFIG_DARWIN
	ant -buildfile skin/client/build.xml mac-jar
endif
endif
endif
build_info:
	@echo "/* Automatically generated by Makefile - do not modify! */" > build_info.h
	@echo "const char build_version[] = \"`cat VERSION`\";" >> build_info.h
	@echo "const char build_date[] = \"`date +"%F %T %Z"`\";" >> build_info.h
	@echo "const char pkginfo_version[] = \"`sed -n '2p' ./../../package/pkginfo.manifest`\";" >> build_info.h

clean:
ifdef CONFIG_WIN32
	rm -f check-hax.exe
else
	
endif
	cd ../../ && $(MAKE) clean
distclean:
	cd ../../ && $(MAKE) distclean
install: all
	mkdir -p $(EMUL_DIR)/bin
	mkdir -p $(EMUL_DIR)/etc
	@for target in $(TARGET_DIRS); do \
	  case "$$target" in \
	  i386-softmmu) \
	    mkdir -p $(EMUL_DIR)/x86 ;\
	    mkdir -p $(EMUL_DIR)/x86/data ;\
	    mkdir -p $(EMUL_DIR)/x86/data/pc-bios ;\
	    echo "Copying i386-softmmu/qemu-system-i386 to $(EMUL_DIR)/bin/emulator-x86" ;\
	    cp ../../i386-softmmu/qemu-system-i386 $(EMUL_DIR)/bin/emulator-x86 ;\
	    cp -dpr ../../pc-bios/bios.bin $(EMUL_DIR)/x86/data/pc-bios ;\
	    cp -dpr ../../pc-bios/linuxboot.bin $(EMUL_DIR)/x86/data/pc-bios ;\
	    cp -dpr ../../pc-bios/pxe-rtl8139.rom $(EMUL_DIR)/x86/data/pc-bios ;\
	    cp -dpr ../../pc-bios/pxe-virtio.rom $(EMUL_DIR)/x86/data/pc-bios ;\
	    cp -dpr ../../pc-bios/vgabios-maruvga.bin $(EMUL_DIR)/x86/data/pc-bios \
	  ;; \
	  arm-softmmu) \
	    mkdir -p $(EMUL_DIR)/arm ;\
	    mkdir -p $(EMUL_DIR)/arm/data ;\
	    echo "Copying arm-softmmu/qemu-system-arm to $(EMUL_DIR)/bin/emulator-arm" ;\
	    cp ../../arm-softmmu/qemu-system-arm $(EMUL_DIR)/bin/emulator-arm ;\
	    if [ ! -z "$$CONFIG_OPENGLES" ] ; then \
	    echo "Copying OpenGLES libraries to $(EMUL_DIR)/bin/" ;\
	    cp -dp -t $(EMUL_DIR)/bin/ $(GLESLIBS_LIST) ;\
	    fi ;\
	  ;; \
	  esac \
	done
	cp skin/client/emulator-skin.jar $(EMUL_DIR)/bin
ifdef CONFIG_WIN32
	cp check-hax.exe $(EMUL_DIR)/bin
endif
	cp ../../qemu-img $(EMUL_DIR)/bin
	cp -dpr skin/client/skins $(EMUL_DIR)
	cp -dpr ../license $(EMUL_DIR)

